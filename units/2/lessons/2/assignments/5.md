[//]: <> (author: Joe Turner)
[//]: <> (type: code along)
[//]: <> (time: 60)

# Sourcing the Twitter API

In the previous lesson we learned about how OAuth works.  So now let's try to implement it in practice.  We are going to be building a command-line Twitter client, which uses OAuth to authenticate with the Twitter API.

## Registering an app

The first thing we need to do is to register our app with Twitter.  If you don't have a Twitter account go ahead and sign up for one.  Then sign in and visit the [Twitter app dashboard](https://apps.twitter.com/).  From there you can create a new application.  When you are asked to enter a callback URL leave this blank, as our app will not be using a callback based authentication flow.

When you have created your app jump over to the permissions tab and change the permissions setting to *Read and Write*.  Then take a quick look at the API keys tab.  You should see an API key, and an API secret.  These values are the client key and secret which you read about in the previous lesson.

## Setting up some structure

Now let's get started setting up some structure for our application.  As a first step we can go through the regular project setup process:

```bash
mkdir tweetful
cd tweetful
git init
virtualenv env
echo env > .gitignore
source env/bin/activate
pip install requests requests-oauthlib
```

Notice that along with the requests library we are also installing requests-oauthlib.  This is a library which works with requests to make it simpler to authenticate using OAuth.

As our project is slightly more complex than what we've worked on before we are going to help keep our code organized by splitting it out into separate files.  In all we are going to have four files:

- *tweetful.py* - The main code for the client
- *authorization.py* - The code carrying out the OAuth authorization
- *urls.py* - A file for storing the relevant API endpoint URLs
- *secret.py* - The place to hide our client secret

So let's set up the files with some basic initialization code and some useful imports.

In *tweetful.py* we can add a stub for the main function:

```python
def main():
    """ Main function """
    pass

if __name__ == "__main__":
    main()
```

In *authorize.py* we can add a stub for a method which will authorize the user:

```python
def authorize():
    pass
```

In *urls.py* we can set up the endpoint URLs:

```python
API_URL = "https://api.twitter.com"
REQUEST_TOKEN_URL = API_URL + "/oauth/request_token"
AUTHORIZE_URL = API_URL + "/oauth/authorize?oauth_token={request_token}"
ACCESS_TOKEN_URL = API_URL + "/oauth/access_token"
TIMELINE_URL = API_URL + "/1.1/statuses/home_timeline.json"
TWEET_URL = API_URL + "/1.1/statuses/update.json"
```

And in secret.py we can add our client key and secret, which you can copy from the app dashboard.

```python
CLIENT_KEY = "ABCDEFGHIJKLMNOP123456789"
CLIENT_SECRET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789ABCDEFGHIJKLMNO"
```

Now that we have some basic structure it seems like a good point to commit your work.

## Getting a request token

Next let's get started on our authorization process.  The first thing we need to do is use our client key to get a request token from Twitter.  This allows us to request authorization for the user to access resources.  In your *authorization.py* file create a new function for requesting the token:

```python
import urlparse

import requests
from requests_oauthlib import OAuth1

from secret import CLIENT_KEY, CLIENT_SECRET
from urls import *

def get_request_token():
    """ Get a token allowing us to request user authorization """
    oauth = OAuth1(CLIENT_KEY, client_secret=CLIENT_SECRET)
    response = requests.post(REQUEST_TOKEN_URL,
                             auth=oauth)
    credentials = urlparse.parse_qs(response.content)

    request_token = credentials.get("oauth_token")[0]
    request_secret = credentials.get("oauth_token_secret")[0]
    return request_token, request_secret
```

First of all we create an instance of the `OAuth1` class from the requests_oauthlib library.  We give this the client key and secret from our *secret.py* file.  Then we make a POST request to the request token endpoint passing in the `oauth` object as our authorization credentials.

In the reponse to our request we get a string in `response.contents` which contains the request token and secret as a query string.  We use the `parse_qs` function from Python's `urlparse` module to create a dictionary containing the token and the secret.  Finally we use the dictionaries `get` method to retrieve the items and return them.

Now let's make another couple of slight modification to our code so we can test out our function.  In the `authorize` function we can call our `get_request_token` function and try to print the results:

```
def authorize():
    """ A complete OAuth authentication flow """
    request_token, request_secret = get_request_token()
    print request_token, request_secret
```

And then in our `main` in *tweetful.py* let's call the `authorize` function:

```
import authorization

def main():
    """ Main function """
    authorization.authorize()
```

Now try running your code using `python tweetful.py`.  You should see the request token and secret being succesfully retreived and printed.

## Getting the user's permission

Now that we have the ability to request that the user authorizes our app we can direct them to a URL where they can obtain a verification code.  This code is then used when we obtain the access token to confirm that the user is granting the app access to their data.  Let's add another function to *authorization.py* to make that happen.

## Getting the access token

## Storing and retrieving the access token

